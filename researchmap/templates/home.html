<!DOCTYPE html>
<html>
  <head>    
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">    
    <meta charset="utf-8">
    <title>Research Map</title>    
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    
    <link href="/static/css/bootstrap.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
<!--     <link href="/static/css/bootstrap-responsive.css" rel="stylesheet"> -->
    
    <script src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=true&key=AIzaSyCZMe3afa1hXz4v9_FzgQ6p2CrKeDGYVtQ"></script>
    
    <script>
        var map;
        function initialize() {
            var mapOptions = {
                zoom: 2,
                center: new google.maps.LatLng(0, 0),
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        }
        google.maps.event.addDomListener(window, 'load', initialize);
        var geocoder = new google.maps.Geocoder();
        var authors = new Array();
        var cur_author = 0;
        function searchMarker(){
            $.getJSON('scholar/' + $('#queryField').val(), function(data) {
                $.each(data, function(key, val) {
                    //alert(val['Affiliation']);
                    authors.push(val);
                    geocoder.geocode({ address: val['Affiliation']}, function(results, status){
                        console.log(results);
                        console.log(status);
                        cur_author++;
                        console.log(authors[cur_author-1]);
                        if (results == null) return;
            
                        $.each(results, function(key, val) {
                            author = authors[cur_author-1]
                            var contentString = 
                                '<div class="author-info">'+
                                '<div class="author-photo"><img src="' + author.Photo + '"/></div>'+
                                '<div class="author-details">'+
                                '<h2>' + author.Name + '</h2>'+
                                '<p>' + author.Affiliation + '</p>';
                            if (author.Homepage != null){
                                contentString += '<p><a href="'+ author.Homepage +'" target="_blank">Homepage</a></p>';
                            }
                            contentString += 
                                '<p><a href="'+ author.URL +'" target="_blank">Google Scholar</a></p>'+
                                '</div></div>';
                            var infowindow = new google.maps.InfoWindow({
                                content: contentString
                            });
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(val['geometry']['location']['jb'], val['geometry']['location']['kb']),
                                map: map,
                                title: val['formatted_address'],
                            //icon: val['icon']
                            //    alert(val);
                            });
                            google.maps.event.addListener(marker, 'click', function() {
                                infowindow.open(map, marker);
                            });
                        });
                    });
                });
            });
            return false;
        }
    </script>
  </head>
  <body>
     <div class="navbar navbar-inverse navbar-fixed-top">
           <div class="navbar-inner">
              <div class="container">
                <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span> <span class="icon-bar"></span> 
                    <span class="icon-bar"></span>
                </button>
                <a class="brand" href="#">Research Map<sup>Beta</sup></a>
                <form class="navbar-form pull-left" action="{{ form.action }}" onsubmit="return searchMarker()">
                    {% csrf_token %}
                    <div class="input-append">
                        {% for field in form %} <input class="input-xlarge" id="queryField" {% if field.value %} value="{{field.value}}" {% endif %} type="text" name="{{field.name}}" placeholder="{{field.label}}"> {% endfor %}
                        <button class="btn" type="submit">Go!</button>
                    </div>
                </form>
                <div class="nav-collapse collapse pull-right">
                    <ul class="nav">
                        <li class="active"><a href="#">Home</a></li>
                        <li><a href="#about">About</a></li>
                        <li><a href="#contact">Contact</a></li>
                    </ul>
                </div>
                <!--/.nav-collapse -->
            </div>
        </div>
    </div>
    <div id="map-canvas"></div>
  </body>
</html>
